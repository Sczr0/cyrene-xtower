import{g as V}from"./DcaBeOso.js";class Q{chunkSize;buffer;index;constructor(n=1e6){this.chunkSize=n,this.buffer=this.generateChunk(),this.index=0}generateChunk(){const n=new Float64Array(this.chunkSize);for(let e=0;e<this.chunkSize;e+=1)n[e]=Math.random();return n}next(){this.index>=this.chunkSize&&(this.buffer=this.generateChunk(),this.index=0);const n=this.buffer[this.index];return this.index+=1,n}}const S=90,d=4;let A=null;const v=.55,tt=1;function k(t,n,e){return Number.isNaN(t)||t<n?n:t>e?e:Math.floor(t)}function Z(t){const n=t+1;return n>=90?1:n<74?.006:.006+(n-73)*.06}function O(t){return t>=3?tt:v}function nt(){const t=Array.from({length:2},()=>Array.from({length:d},()=>new Float64Array(S))),n=new Float64Array(S);for(let e=S-1;e>=0;e--){const u=Z(e);e===S-1?n[e]=1:n[e]=1+(1-u)*n[e+1]}for(let e=0;e<d;e++)for(let u=0;u<S;u++)t[1][e][u]=n[u];for(let e=0;e<d;e++){const i=1-O(e);for(let o=S-1;o>=0;o--){const s=Z(o),r=1+i*n[0];if(o===S-1)t[0][e][o]=r;else{const a=t[0][e][o+1];t[0][e][o]=s*r+(1-s)*(1+a)}}}A=t}function et(){A||nt()}function rt(t){if(et(),!A)throw new Error("Tables not initialized");const n=t.initialState,e=k(n.pity,0,S-1),u=k(n.mingguangCounter,0,d-1),i=n.isGuaranteed,o=Math.max(1,Math.floor(t.targetCount));let s=i?A[1][u][e]:A[0][u][e];if(o===1)return{mean:s};let r=new Array(d).fill(0);if(i){const l=Math.min(u+1,d-1);r[l]=1}else{const l=O(u);if(r[0]+=l,l<1){const f=Math.min(u+1,d-1);r[f]+=1-l}}const a=A[0].map(l=>l[0]);for(let l=1;l<o;l++){let f=0;for(let p=0;p<d;p++)r[p]>1e-9&&(f+=r[p]*a[p]);s+=f;const c=new Array(d).fill(0);for(let p=0;p<d;p++){const x=r[p];if(x<=1e-9)continue;const F=O(p);if(c[0]+=x*F,F<1){const K=Math.min(p+1,d-1);c[K]+=x*(1-F)}}r=c}return{mean:s}}function h(t){if(!t.length)return{mean:0};const n=[...t].sort((o,s)=>o-s),e=n.length,u=n.reduce((o,s)=>o+s,0)/e,i=o=>{if(e===1)return n[0];const s=Math.min(e-1,Math.max(0,Math.floor(o/100*e)));return n[s]};return{mean:u,p25:i(25),p50:i(50),p75:i(75),p90:i(90),p95:i(95)}}function T(t,n){return!t.length||n<=0?0:t.filter(u=>u<=n).length/t.length*100}const ot=1e5,it=7,U=44,ut=18,st=U+ut,at=.55,lt=1;function ct(t){const n=t+1;return n>=90?1:n<74?.006:.006+(n-73)*.06}function ft(t){return t>=3?lt:at}function X(t,n,e){if(t){const s=(n.up_5_star??0)+1;return n.up_5_star=s,s<=7?10:25}const i=`std_5_star_${Math.floor(e.next()*it)}`,o=(n[i]??0)+1;return n[i]=o,o===1?0:o<=7?10:25}function pt(t,n,e,u){if(t.pity4=0,t.isGuaranteed4||n.next()<.5)return t.isGuaranteed4=!1,u?5:2;if(t.isGuaranteed4=!0,n.next()<U/st){const o=`std_char_${Math.floor(n.next()*U)}`,s=(e[o]??0)+1;return e[o]=s,s===1?0:s<=7?2:5}return 2}function ht(t,n,e,u){let i=0,o=0;for(;;){i+=1,t.pity+=1,t.pity4+=1;const s=ct(t.pity-1);if(n.next()<s){const r=t.isGuaranteed;let a=!1;if(r)a=!0,t.mingguangCounter+=1,t.isGuaranteed=!1;else{const l=ft(t.mingguangCounter);a=n.next()<l,a?(t.mingguangCounter=0,t.isGuaranteed=!1):(t.mingguangCounter+=1,t.isGuaranteed=!0)}if(t.pity=0,t.pity4=0,a)return o+=X(!0,e,n),{pulls:i,returns:o};o+=X(!1,e,n)}else{const r=s<1?1-s:.01;(t.pity4>=10||n.next()<.051/r)&&(o+=pt(t,n,e,u))}}}function dt(t,n){const e={pity:Math.max(0,Math.floor(t.initialState.pity)),pity4:0,isGuaranteed:!!t.initialState.isGuaranteed,isGuaranteed4:!1,mingguangCounter:Math.max(0,Math.floor(t.initialState.mingguangCounter))},u={up_5_star:0};let i=0,o=0;const s=Math.max(1,Math.floor(t.targetCount));for(let r=0;r<s;r+=1){const{pulls:a,returns:l}=ht(e,n,u,t.up4C6);i+=a,o+=l}return{pulls:i,returns:o}}function xt(t,n,e){const u=e??ot,i=[],o=[];for(let a=0;a<u;a+=1){const{pulls:l,returns:f}=dt(t,n);i.push(l),o.push(f)}const r={pulls:h(i)};return t.budget!=null&&(r.successRate=T(i,t.budget)),o.length&&(r.returns=h(o)),r}const _=80,St=2;let y=null;function H(t,n,e){return Number.isNaN(t)||t<n?n:t>e?e:Math.floor(t)}function Y(t){const n=t+1;return n>=80?1:n<63?.007:.007+(n-62)*.07}function _t(t){return .375}function At(){const t=Array.from({length:St},()=>new Float64Array(_));for(let n=_-1;n>=0;n--){const e=Y(n);n===_-1?t[1][n]=1:t[1][n]=1+(1-e)*t[1][n+1]}for(let n=_-1;n>=0;n--){const e=Y(n),i=1-_t(),o=t[1][0];if(n===_-1)t[0][n]=1+i*o;else{const s=t[0][n+1],r=1+i*o;t[0][n]=e*r+(1-e)*(1+s)}}y=t}function Tt(){y||At()}function yt(t){if(Tt(),!y)throw new Error("Table not initialized");const n=H(t.initialState.pity,0,_-1);let e=H(t.initialState.fatePoint,0,1);const u=Math.max(1,Math.floor(t.targetCount));let i=y[e][n];if(u>1){const o=y[0][0];i+=(u-1)*o}return{mean:i}}const Mt=5e4,L=44,$t=18,mt=L+$t,D=1;function wt(t){const n=t+1;return n>=80?1:n<64?.007:.007+(n-63)*.07}function Gt(t){return t>=D}function Rt(t){return t?{win:1,lose:0}:{win:.375,lose:.625}}function gt(t,n,e){if(t.pity4=0,t.isGuaranteed4||n.next()<.75)return t.isGuaranteed4=!1,2;if(t.isGuaranteed4=!0,n.next()<L/mt){const i=`std_char_${Math.floor(n.next()*L)}`,o=(e[i]??0)+1;return e[i]=o,o===1?0:o<=7?2:5}return 2}function bt(t,n,e){let u=0,i=0;for(;;){u+=1,t.pity+=1,t.pity4+=1;const o=wt(t.pity-1);if(n.next()<o){const s=Gt(t.fatePoint),{win:r}=Rt(s),a=n.next()<r;if(t.pity=0,t.pity4=0,i+=10,a)return t.fatePoint=0,t.isGuaranteed=!1,{pulls:u,returns:i};t.fatePoint=Math.min(t.fatePoint+1,D),t.isGuaranteed=!0}else{const s=o<1?1-o:.01;(t.pity4>=10||n.next()<.06/s)&&(i+=gt(t,n,e))}}}function Et(t,n){const e={pity:Math.max(0,Math.floor(t.initialState.pity)),pity4:0,isGuaranteed:!!t.initialState.isGuaranteed,isGuaranteed4:!1,fatePoint:Math.min(Math.max(0,Math.floor(t.initialState.fatePoint)),D)};(e.isGuaranteed||e.fatePoint>=1)&&(e.fatePoint=1);const u={};let i=0,o=0;const s=Math.max(1,Math.floor(t.targetCount));for(let r=0;r<s;r+=1){const{pulls:a,returns:l}=bt(e,n,u);i+=a,o+=l}return{pulls:i,returns:o}}function Nt(t,n,e){const u=e??Mt,i=[],o=[];for(let a=0;a<u;a+=1){const{pulls:l,returns:f}=Et(t,n);i.push(l),o.push(f)}const r={pulls:h(i)};return t.budget!=null&&(r.successRate=T(i,t.budget)),o.length&&(r.returns=h(o)),r}const I=V();function B(t,n){const e=t.length;if(!e)return[];if(t[0].length!==e)throw new Error(I.engineErrors.matrixNotSquare);if(n.length!==e)throw new Error(I.engineErrors.matrixVectorMismatch);const i=t.map(r=>r.slice()),o=n.slice();for(let r=0;r<e;r+=1){let a=r,l=Math.abs(i[r][r]);for(let c=r+1;c<e;c+=1){const p=Math.abs(i[c][r]);p>l&&(l=p,a=c)}if(l===0)throw new Error(I.engineErrors.matrixSingular);if(a!==r){const c=i[r];i[r]=i[a],i[a]=c;const p=o[r];o[r]=o[a],o[a]=p}const f=i[r][r];for(let c=r;c<e;c+=1)i[r][c]/=f;o[r]/=f;for(let c=r+1;c<e;c+=1){const p=i[c][r];if(p!==0){for(let x=r;x<e;x+=1)i[c][x]-=p*i[r][x];o[c]-=p*o[r]}}}const s=new Array(e).fill(0);for(let r=e-1;r>=0;r-=1){let a=o[r];for(let l=r+1;l<e;l+=1)a-=i[r][l]*s[l];s[r]=a}return s}const M=90,Ct=2,Pt=M*Ct;let g=null,b=null;function w(t,n){return t+n*M}function Ft(t,n,e){return Number.isNaN(t)||t<n?n:t>e?e:Math.floor(t)}function It(t){const n=t+1;return n>=90?1:n<74?.006:.006+(n-73)*.06}function Ot(t){return t?{win:1,lose:0}:{win:.5,lose:.5}}function Ut(){if(!g||b==null){const{table:t,zeroExpectation:n}=Lt();g=t,b=n}}function Lt(){const t=Pt,n=Array.from({length:t},(r,a)=>{const l=new Array(t).fill(0);return l[a]=1,l}),e=new Array(t).fill(1);for(let r=0;r<t;r+=1){const a=Math.floor(r/M),l=r%M,f=It(l);if(f<1){const c=w(l+1,a);n[r][c]-=1-f}if(f>0){const{lose:c}=Ot(!!a);if(c>0){const p=w(0,1);n[r][p]-=f*c}}}const u=B(n,e),i=new Float64Array(u),o=w(0,0),s=i[o];return{table:i,zeroExpectation:s}}function j(t){if(Ut(),!g||b==null)throw new Error("HSR 角色池期望表尚未初始化");const n=Ft(t.initialState.pity,0,M-1),e=t.initialState.isGuaranteed?1:0,u=Math.max(1,Math.floor(t.targetCount)),i=w(n,e);return{mean:g[i]+(u-1)*b}}const Wt=1e5,zt=7,W=22,Dt=29,Bt=W+Dt;function kt(t){const n=t+1;return n>=90?1:n<74?.006:.006+(n-73)*.06}function Zt(t){return t?{win:1,lose:0}:{win:.5625,lose:.4375}}function q(t,n,e){if(t){const s=(n.up_5_star??0)+1;return n.up_5_star=s,s<=7?40:100}const i=`std_5_star_${Math.floor(e.next()*zt)}`,o=(n[i]??0)+1;return n[i]=o,o===1?0:o<=7?40:100}function Xt(t,n,e,u){if(t.pity4=0,t.isGuaranteed4||n.next()<.5)return t.isGuaranteed4=!1,u?20:8;if(t.isGuaranteed4=!0,n.next()<W/Bt){const o=`std_char_${Math.floor(n.next()*W)}`,s=(e[o]??0)+1;return e[o]=s,s===1?0:s<=7?8:20}return 8}function Ht(t,n,e,u){let i=0,o=0;for(;;){i+=1,t.pity+=1,t.pity4+=1;const s=kt(t.pity-1);if(n.next()<s){const r=t.isGuaranteed,{win:a}=Zt(r),l=n.next()<a;if(t.pity=0,t.pity4=0,l)return o+=q(!0,e,n),t.isGuaranteed=!1,{pulls:i,returns:o};o+=q(!1,e,n),t.isGuaranteed=!0}else{const r=s<1?1-s:.99;(t.pity4>=10||n.next()<.051/r)&&(o+=Xt(t,n,e,u))}}}function Yt(t,n){const e={pity:Math.max(0,Math.floor(t.initialState.pity)),pity4:0,isGuaranteed:!!t.initialState.isGuaranteed,isGuaranteed4:!1},u={up_5_star:0};let i=0,o=0;const s=Math.max(1,Math.floor(t.targetCount));for(let r=0;r<s;r+=1){const{pulls:a,returns:l}=Ht(e,n,u,t.up4C6);i+=a,o+=l}return{pulls:i,returns:o}}function qt(t,n,e){const u=e??Wt,i=[],o=[];for(let a=0;a<u;a+=1){const{pulls:l,returns:f}=Yt(t,n);i.push(l),o.push(f)}const r={pulls:h(i)};return t.budget!=null&&(r.successRate=T(i,t.budget)),o.length&&(r.returns=h(o)),r}const $=80,Vt=2,jt=$*Vt;let E=null,N=null;function Jt(t,n,e){return Number.isNaN(t)||t<n?n:t>e?e:Math.floor(t)}function G(t,n){return t+n*$}function Kt(t){const n=t+1;return n>=80?1:n<66?.008:.008+(n-65)*.08}function Qt(t){return t?{win:1,lose:0}:{win:.75,lose:.25}}function vt(){if(!E||N==null){const{table:t,zeroExpectation:n}=tn();E=t,N=n}}function tn(){const t=jt,n=Array.from({length:t},(r,a)=>{const l=new Array(t).fill(0);return l[a]=1,l}),e=new Array(t).fill(1);for(let r=0;r<t;r+=1){const a=Math.floor(r/$),l=r%$,f=Kt(l);if(f<1){const c=G(l+1,a);n[r][c]-=1-f}if(f>0){const{lose:c}=Qt(!!a);if(c>0){const p=G(0,1);n[r][p]-=f*c}}}const u=B(n,e),i=new Float64Array(u),o=G(0,0),s=i[o];return{table:i,zeroExpectation:s}}function nn(t){if(vt(),!E||N==null)throw new Error("HSR 光锥池期望表尚未初始化");const n=Jt(t.initialState.pity,0,$-1),e=t.initialState.isGuaranteed?1:0,u=Math.max(1,Math.floor(t.targetCount)),i=G(n,e);return{mean:E[i]+(u-1)*N}}const en=5e4,z=22,rn=29,on=z+rn;function un(t){const n=t+1;return n>=80?1:n<66?.008:.008+(n-65)*.08}function sn(t){return t?{win:1,lose:0}:{win:.75,lose:.25}}function an(){return 40}function ln(t,n,e,u){if(t.pity4=0,t.isGuaranteed4||n.next()<.75)return t.isGuaranteed4=!1,8;if(t.isGuaranteed4=!0,n.next()<z/on){const o=`std_char_${Math.floor(n.next()*z)}`,s=(e[o]??0)+1;return e[o]=s,s===1?0:s<=7?8:20}return 8}function cn(t,n,e,u){let i=0,o=0;for(;;){i+=1,t.pity+=1,t.pity4+=1;const s=un(t.pity-1);if(n.next()<s){const r=t.isGuaranteed,{win:a}=sn(r),l=n.next()<a;if(t.pity=0,t.pity4=0,o+=an(),l)return t.isGuaranteed=!1,{pulls:i,returns:o};t.isGuaranteed=!0}else{const r=s<1?1-s:.99;(t.pity4>=10||n.next()<.066/r)&&(o+=ln(t,n,e,u))}}}function fn(t,n){const e={pity:Math.max(0,Math.floor(t.initialState.pity)),pity4:0,isGuaranteed:!!t.initialState.isGuaranteed,isGuaranteed4:!1},u={};let i=0,o=0;const s=Math.max(1,Math.floor(t.targetCount));for(let r=0;r<s;r+=1){const{pulls:a,returns:l}=cn(e,n,u,t.up4C6);i+=a,o+=l}return{pulls:i,returns:o}}function pn(t,n,e){const u=e??en,i=[],o=[];for(let a=0;a<u;a+=1){const{pulls:l,returns:f}=fn(t,n);i.push(l),o.push(f)}const r={pulls:h(i)};return t.budget!=null&&(r.successRate=T(i,t.budget)),o.length&&(r.returns=h(o)),r}function hn(t){return j(t)}const dn=1e5,xn=6,Sn=12;function _n(t){const n=t+1;return n>=90?1:n<74?.006:.006+(n-73)*.06}function An(t){return t?{win:1,lose:0}:{win:.5,lose:.5}}function Tn(t,n,e){let u;t?u="up_5_star":u=`std_5_star_${Math.floor(e.next()*xn)}`;const i=(n[u]??0)+1;return n[u]=i,i===1?0:i<=7?40:100}function yn(t,n,e,u){if(t.pity4=0,t.isGuaranteed4||n.next()<.5)return t.isGuaranteed4=!1,u?20:8;t.isGuaranteed4=!0;const i=7.05/(7.05+2.35);if(n.next()<i){const s=`std_char_${Math.floor(n.next()*Sn)}`,r=(e[s]??0)+1;return e[s]=r,r===1?0:r<=7?8:20}return 8}function Mn(t,n,e,u){let i=0,o=0;for(;;){i+=1,t.pity+=1,t.pity4+=1;const s=_n(t.pity-1);if(n.next()<s){const r=t.isGuaranteed,{win:a}=An(r),l=n.next()<a;if(t.pity=0,t.pity4=0,o+=Tn(l,e,n),l)return t.isGuaranteed=!1,{pulls:i,returns:o};t.isGuaranteed=!0}else{const r=s<1?1-s:.99;(t.pity4>=10||n.next()<.094/r)&&(o+=yn(t,n,e,u))}}}function $n(t,n){const e={pity:Math.max(0,Math.floor(t.initialState.pity)),pity4:0,isGuaranteed:!!t.initialState.isGuaranteed,isGuaranteed4:!1},u={up_5_star:0};let i=0,o=0;const s=Math.max(1,Math.floor(t.targetCount));for(let r=0;r<s;r+=1){const{pulls:a,returns:l}=Mn(e,n,u,t.up4C6);i+=a,o+=l}return{pulls:i,returns:o}}function mn(t,n,e){const u=e??dn,i=[],o=[];for(let a=0;a<u;a+=1){const{pulls:l,returns:f}=$n(t,n);i.push(l),o.push(f)}const r={pulls:h(i)};return t.budget!=null&&(r.successRate=T(i,t.budget)),o.length&&(r.returns=h(o)),r}const m=80,wn=2,Gn=m*wn;let C=null,P=null;function Rn(t,n,e){return Number.isNaN(t)||t<n?n:t>e?e:Math.floor(t)}function R(t,n){return t+n*m}function gn(t){const n=t+1;return n>=80?1:n<65?.01:.01+(n-64)*.061875}function bn(t){return t?{win:1,lose:0}:{win:.75,lose:.25}}function En(){if(!C||P==null){const{table:t,zeroExpectation:n}=Nn();C=t,P=n}}function Nn(){const t=Gn,n=Array.from({length:t},(r,a)=>{const l=new Array(t).fill(0);return l[a]=1,l}),e=new Array(t).fill(1);for(let r=0;r<t;r+=1){const a=Math.floor(r/m),l=r%m,f=gn(l);if(f<1){const c=R(l+1,a);n[r][c]-=1-f}if(f>0){const{lose:c}=bn(!!a);if(c>0){const p=R(0,1);n[r][p]-=f*c}}}const u=B(n,e),i=new Float64Array(u),o=R(0,0),s=i[o];return{table:i,zeroExpectation:s}}function Cn(t){if(En(),!C||P==null)throw new Error("ZZZ weapon expectation table not initialized");const n=Rn(t.initialState.pity,0,m-1),e=t.initialState.isGuaranteed?1:0,u=Math.max(1,Math.floor(t.targetCount)),i=R(n,e);return{mean:C[i]+(u-1)*P}}const Pn=5e4,Fn=12;function In(t){const n=t+1;return n>=80?1:n<65?.01:.01+(n-64)*.061875}function On(t){return t?{win:1,lose:0}:{win:.75,lose:.25}}function Un(t,n,e){if(t.pity4=0,t.isGuaranteed4||n.next()<.75)return t.isGuaranteed4=!1,8;t.isGuaranteed4=!0;const u=13.125/(13.125+1.875);if(n.next()<u)return 8;const o=`std_char_${Math.floor(n.next()*Fn)}`,s=(e[o]??0)+1;return e[o]=s,s===1?0:s<=7?8:20}function Ln(t,n,e){let u=0,i=0;for(;;){u+=1,t.pity+=1,t.pity4+=1;const o=In(t.pity-1);if(n.next()<o){const s=t.isGuaranteed,{win:r}=On(s),a=n.next()<r;if(t.pity=0,t.pity4=0,i+=40,a)return t.isGuaranteed=!1,{pulls:u,returns:i};t.isGuaranteed=!0}else{const s=o<1?1-o:.99;(t.pity4>=10||n.next()<.15/s)&&(i+=Un(t,n,e))}}}function Wn(t,n){const e={pity:Math.max(0,Math.floor(t.initialState.pity)),pity4:0,isGuaranteed:!!t.initialState.isGuaranteed,isGuaranteed4:!1},u={};let i=0,o=0;const s=Math.max(1,Math.floor(t.targetCount));for(let r=0;r<s;r+=1){const{pulls:a,returns:l}=Ln(e,n,u);i+=a,o+=l}return{pulls:i,returns:o}}function zn(t,n,e){const u=e??Pn,i=[],o=[];for(let a=0;a<u;a+=1){const{pulls:l,returns:f}=Wn(t,n);i.push(l),o.push(f)}const r={pulls:h(i)};return t.budget!=null&&(r.successRate=T(i,t.budget)),o.length&&(r.returns=h(o)),r}const J=V();function Bn(t){const n=`${t.game}-${t.pool}`;switch(n){case"genshin-character":return rt(t);case"genshin-weapon":return yt(t);case"hsr-character":return j(t);case"hsr-lightcone":return nn(t);case"zzz-character":return hn(t);case"zzz-weapon":return Cn(t);default:throw new Error(J.engineErrors.unsupportedCombination(n))}}function kn(t,n){const e=`${t.game}-${t.pool}`,u=new Q;switch(e){case"genshin-character":return xt(t,u,n);case"genshin-weapon":return Nt(t,u,n);case"hsr-character":return qt(t,u,n);case"hsr-lightcone":return pn(t,u,n);case"zzz-character":return mn(t,u,n);case"zzz-weapon":return zn(t,u,n);default:throw new Error(J.engineErrors.unsupportedCombination(e))}}export{kn as runDistribution,Bn as runExpectation};
